name: CI

on:
  pull_request:
  push:
    tags:
      - "**"
    branches:
      - main

env:
  BUSTER_CI: 1
  BUSTER_BUILD_DEBUG: 1
  BUSTER_BUILD_NATIVE: 0
  BUSTER_LLVM_VERSION: 21.1.7
jobs:
  ci:
    strategy:
      fail-fast: false
      matrix:
        os: [ self-hosted, ubuntu-24.04, macos-15-intel, windows-2025, ubuntu-24.04-arm, macos-26, windows-11-arm ]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Build and test (UNIX)
        shell: bash
        env:
          BUSTER_OS_TAG: ${{matrix.os}}
        if: matrix.os != 'windows-2025' && matrix.os != 'windows-11-arm'
        run: |
          set -euo pipefail

          for optimize in 0 1; do
            for fuzz in 0 1; do
              echo "Optimize=$optimize. Fuzz=$fuzz"
              rm -rf build
              ./build.sh test --optimize="$optimize" --fuzz="$fuzz"
            done
          done
      - name: Build and test (Windows)
        if: matrix.os == 'windows-2025' || matrix.os == 'windows-11-arm'
        shell: cmd
        env:
          BUSTER_OS_TAG: ${{matrix.os}}
        run: |
          @echo off
          setlocal EnableExtensions EnableDelayedExpansion

          set EXIT_CODE=0
          if "%BUSTER_OS_TAG%"=="windows-11-arm" (
            set FUZZ_VALUES=0
          ) else (
            set FUZZ_VALUES=0 1
          )

          for %%O in (0 1) do (
            for %%F in (!FUZZ_VALUES!) do (
              echo Optimize=%%O. Fuzz=%%F
              if exist build rmdir /s /q build

              call build.bat test --optimize=%%O --fuzz=%%F
              if errorlevel 1 (
                echo build.bat failed: !errorlevel!
                set EXIT_CODE=!errorlevel!
                goto :done
              )
            )
          )

          :done
          exit /b %EXIT_CODE%
